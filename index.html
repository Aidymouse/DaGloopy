<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="css/desk.css" />
    <link rel="stylesheet" href="css/shelf.css" />
    <link rel="stylesheet" href="css/viewer.css" />

    <script src="./js/showdown.min.js"></script>

    <script type="module">
      import { process_markdown } from "./js/markdown.js";

      window.go_to_shelf_view = () => {
        shelf_view.style.left = "0%";
        desk_view.style.left = "-100%";
        //window.history.pushState({"pageTitle":"The Shelf"}, "theshelf")
      };

      window.go_to_desk_view = () => {
        shelf_view.style.left = "100%";
        desk_view.style.left = "0%";
      };

      /** Navigation **/
      /*
	window.addEventListener("popstate", e => {
		console.log(e)
	})
	*/

      /** DESK VIEW EVENTS **/
      // Happens when something dropped not on desktop (desktop will stop propagation)
      window.desk_view_dragover = (e) => {
        e.preventDefault();
      };

      window.desk_view_drop = (e) => {
        // Send it back to the library!
      };

      /** DESKTOP EVENTS **/
      window.desktop_drop = (e) => {
        if (dragged_article) {
          drop_article_onto_desk(e);
        } else if (dragged_book) {
          drop_book_onto_desk(e);
        }
      };

      const drop_article_onto_desk = (e) => {
        e.stopPropagation(); // Stops event from going to desk view

        const desktop_rect = desktop.getBoundingClientRect();

        const dropX = e.clientX - desktop_rect.x;
        const dropY = e.clientY - desktop_rect.y;

        const drop_delta = {
          x: dropX - article_drag.og_pos.x,
          y: dropY - article_drag.og_pos.y,
        };

        const article_rect = dragged_article.getBoundingClientRect();

        dragged_article.style.left = `${article_rect.x + drop_delta.x}px`;
        dragged_article.style.top = `${article_rect.y + drop_delta.y}px`;
      };

      const drop_book_onto_desk = (e) => {
        console.log(dragged_book);

        const book_url = dragged_book.getAttribute("data-contenturl");

        desktop.innerHTML += `<article
					id="book_${"book"}"
				  draggable="true"
				  ondragstart="article_ondragstart(event)"
				  ondragend="article_ondragend(event)"
				>
				  <h2>${"Hello"}</h2>
				  <p>${"This artcle"}</p>
				</article>`;
      };

      window.desk_dragover = (e) => {
        e.preventDefault();
      };

      /** ARTICLE EVENTS **/
      let article_drag = {
        og_pos: { x: 0, y: 0 },
      };
      let dragged_article = null;

      window.article_ondragend = (e) => {
        e.target.style.opacity = "1";
        dragged_article = null;
      };

      window.article_ondragstart = (e) => {
        e.target.style.opacity = "0.1";

        const desktop_rect = desktop.getBoundingClientRect();
        article_drag.og_pos = {
          x: e.clientX - desktop_rect.x,
          y: e.clientY - desktop_rect.y,
        };

        dragged_article = e.target;
      };

      /** Shelf Code */

      window.load_shelf = () => {};
      let dragged_book = null;

      window.enter_drop_zone = (e) => {
        go_to_desk_view();
      };

      window.book_dragstart = (e) => {
        dragged_book = e.target;
      };
      window.book_dragend = (e) => {
        dragged_book = null;
      };

      /** VIEWER CODE **/
      window.book_pointerup = (e) => {
        const content = e.currentTarget.getAttribute("data-contenturl");
        console.log(content);

        load_article(
          `public/${content}`,
          async (res, processed, text = null) => {
            article_content.innerHTML = processed;
          },
        );

        initiate_viewer(e);
      };

      window.initiate_viewer = (e) => {
        viewer_view.style.display = "flex";

        const clicked_rect = e.currentTarget.getBoundingClientRect()

        floating_loader.style.width = `${clicked_rect.width}px`
        floating_loader.style.height = `${clicked_rect.height}px`
        floating_loader.style.left = `${clicked_rect.x}px`
        floating_loader.style.top = `${clicked_rect.y}px`

        // TODO: update instantly but animate from here - maybe use CSS animation? https://stackoverflow.com/questions/49286413/changing-an-html-elements-style-in-javascript-with-its-css-transition-temporari

        floating_loader.style['transition-duration'] = '0.2s'



      };

      window.close_viewer = () => {
        viewer_view.style.display = "none";
        article_content.innerHTML = "";
      };

      /**
       * @param url (string)
       * @param load_callback (async (res, processed_content, text=null) => void)
       * NOTE: the text is already read on the res it'll be passed back as the text property, otherwise null
       */
      window.load_article = (url, load_callback) => {
        if (!url.includes("content")) {
          console.warn(
            `URL ${url} doesn't appear to be in the content folder, not loading`,
          );
          return;
        }

        const file_type = url.split(".").pop();
        console.log(file_type);

        // TODO: headers based on file type
        // TODO: update loaded article register (cache?)

        fetch(url, {
          headers: { "Content-Type": "text/plain" },
        }).then(async (res) => {
          let text = null;
          let processed = "";

          // Processing
          if (file_type === "md") {
            text = await res.text();
            // Run through MD parser
            processed = process_markdown(text);
          }

          await load_callback(res, processed, text);
        });
      };
    </script>
  </head>

  <body>
    <main
      class="screen"
      id="desk_view"
      ondrop="desk_view_drop(event)"
      ondragover="desk_view_dragover(event)"
    >
      <!-- THE DESK -->
      <section
        id="desktop"
        ondragover="desk_dragover(event)"
        ondrop="desktop_drop(event)"
      >
        <article
          draggable="true"
          ondragstart="article_ondragstart(event)"
          ondragend="article_ondragend(event)"
        >
          <h2>Test</h2>
          <p>This is the context of test two. Not the summary! Lololol.</p>
        </article>
      </section>

      <nav height="5em">
        <button onclick="go_to_shelf_view()">To Shelf</button>
      </nav>
    </main>

    <!-- THE SHELF -->

    <main class="screen" id="shelf_view">
      <nav id="shelftop">
        <section id="shelftop-content">
          <button onclick="go_to_desk_view()">To Desk</button>
        </section>
      </nav>

      <section id="shelf">
        <div class="shelf-seperator"></div>
        <section class="shelf-bay">
          <!-- Code populated start -->
          <article
            class="book"
            draggable="true"
            ondragstart="book_dragstart(event)"
            ondragend="book_dragend(event)"
            onpointerup="book_pointerup(event)"
            data-contenturl="content/dagloopyrpg/12 room dungeon blocks.md"
          >
            <h2>12 Room Dungeon Blocks</h2>
          </article>

          <article
            class="book"
            draggable="true"
            ondragstart="book_dragstart(event)"
            ondragend="book_dragend(event)"
            onpointerup="book_pointerup(event)"
            data-contenturl="content/dagloopyrpg/birthright, mausritter, rules light warfare.md"
          >
            <h2>Birthright, Mausritter, Rules Light Warfare</h2>
          </article>

          <!-- Code populated end -->
        </section>

        <div class="shelf-seperator"></div>
        <section class="shelf-bay"></section>
        <div class="shelf-seperator"></div>
        <section class="shelf-bay"></section>
        <div class="shelf-seperator"></div>
      </section>

      <section
        id="desk-drop-zone"
        ondragenter="enter_drop_zone(event)"
      ></section>
    </main>

    <main class="screen" id="viewer_view">
      <section id="floating_loader">
      </section>

      <section id="viewed_article">
		  <nav>
		    <button onclick="close_viewer()">Back</button>
		  </nav>

		  <article id="article_content">
		  </article>

		  <nav>
		    <button onclick="close_viewer()">Back</button>
		  </nav>
      </section>

    </main>
  </body>
</html>
