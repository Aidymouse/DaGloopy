<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="css/desk.css" />
    <link rel="stylesheet" href="css/shelf.css" />
    <link rel="stylesheet" href="css/viewer.css" />

    <script src="./js/showdown.min.js"></script>

    <script type="module">
      import { process_markdown } from "./js/markdown.js";

      window.go_to_shelf_view = () => {
        shelf_view.style.left = "0%";
        desk_view.style.left = "-100%";
        //window.history.pushState({"pageTitle":"The Shelf"}, "theshelf")
      };

      window.go_to_desk_view = () => {
        shelf_view.style.left = "100%";
        desk_view.style.left = "0%";
      };

      /** Navigation **/
      /*
	window.addEventListener("popstate", e => {
		console.log(e)
	})
	*/

      /** DESK VIEW EVENTS **/
      // Happens when something dropped not on desktop (desktop will stop propagation)
      window.desk_view_dragover = (e) => {
        e.preventDefault();
      };

      window.desk_view_drop = (e) => {
        // Send it back to the library!
      };

      /** DESKTOP EVENTS **/
      window.desktop_drop = (e) => {
        if (dragged_article) {
          drop_article_onto_desk(e);
        } else if (dragged_book) {
          drop_book_onto_desk(e);
        }
      };

      const drop_article_onto_desk = (e) => {
        e.stopPropagation(); // Stops event from going to desk view

        const desktop_rect = desktop.getBoundingClientRect();

        const dropX = e.clientX - desktop_rect.x;
        const dropY = e.clientY - desktop_rect.y;

        const drop_delta = {
          x: dropX - article_drag.og_pos.x,
          y: dropY - article_drag.og_pos.y,
        };

        const article_rect = dragged_article.getBoundingClientRect();

        dragged_article.style.left = `${article_rect.x + drop_delta.x}px`;
        dragged_article.style.top = `${article_rect.y + drop_delta.y}px`;
      };

      const drop_book_onto_desk = (e) => {
        console.log(dragged_book);

        const book_url = dragged_book.getAttribute("data-contenturl");

        desktop.innerHTML += `<article
				id="book_${"book"}"
				draggable="true"
				ondragstart="article_ondragstart(event)"
				ondragend="article_ondragend(event)"
			      >
				<h2>${"Hello"}</h2>
				<p>${"This artcle"}</p>
			      </article>`;
      };

      window.desk_dragover = (e) => {
        e.preventDefault();
      };

      /** ARTICLE EVENTS **/
      let article_drag = {
        og_pos: { x: 0, y: 0 },
      };
      let dragged_article = null;

      window.article_ondragend = (e) => {
        e.target.style.opacity = "1";
        dragged_article = null;
      };

      window.article_ondragstart = (e) => {
        e.target.style.opacity = "0.1";

        const desktop_rect = desktop.getBoundingClientRect();
        article_drag.og_pos = {
          x: e.clientX - desktop_rect.x,
          y: e.clientY - desktop_rect.y,
        };

        dragged_article = e.target;
      };

      /**
       * SHELF CODE
       */
      window.load_shelf = () => {};
      let dragged_book = null;

      window.enter_drop_zone = (e) => {
        go_to_desk_view();
      };

      window.book_dragstart = (e) => {
        dragged_book = e.target;
      };
      window.book_dragend = (e) => {
        dragged_book = null;
      };

      /**
       * VIEWER CODE
       **/
      const trans = 0.4;
      let viewed_book = null;
      window.book_pointerup = (e) => {
        const content = e.currentTarget.getAttribute("data-contenturl");

        e.currentTarget.style.opacity = "0";
        viewed_book = e.currentTarget;

        load_article(
          `public/${content}`,
          async (res, processed, text = null) => {
            // Simulate 1 second load time with setTimeout
            setTimeout(() => {
              article_content.innerHTML = processed;
              mock_article_content.innerHTML = processed;

              floating_loader.style.height = "auto";
              article_content.classList.add("open");
              mock_article_content.classList.add("open");
            }, 0);
          },
        );

        initiate_viewer(e);
      };

      window.initiate_viewer = (e) => {
        viewer_view.style.display = "flex";

        mock_article_content.classList.add("loading");

        const clicked_rect = e.currentTarget.getBoundingClientRect();

        floating_loader.style["transition-duration"] = "0s";
        floating_loader.style.width = `${clicked_rect.width}px`;
        floating_loader.style.height = `${clicked_rect.height}px`;
        floating_loader.style.left = `${clicked_rect.x}px`;
        floating_loader.style.top = `${clicked_rect.y}px`;

        // WARN: this is a hack that recalculates dom positioning and updates floating_loader instantly rather than using a propery animation approach
        let x = floating_loader.offsetLeft;
        // TODO: update instantly but animate from here - maybe use CSS animation? https://stackoverflow.com/questions/49286413/changing-an-html-elements-style-in-javascript-with-its-css-transition-temporari

        floating_loader.style["transition-duration"] = `${trans}s`;

        const article_rect = viewed_article.getBoundingClientRect();

        floating_loader.style.left = `${article_rect.x}px`;
        floating_loader.style.top = `${article_rect.y}px`;
        floating_loader.style.height = `${article_rect.height}px`;
        floating_loader.style.width = `${article_rect.width}px`;
        floating_loader.classList.add("open");

        viewer_view.style["background-color"] = "rgba(0, 0, 0, 0.6)";

        const navs = document.getElementsByClassName("viewer-nav");
        for (const nav of navs) {
          nav.classList.add("open");
        }

        setTimeout( () => {
            viewed_article.style.opacity = "1"
            floating_loader.style.opacity = "0"
          }, trans * 1000)
      };

      window.close_viewer = () => {
        // What we should actually do it, clone the open article onto the shelf layer, and let if fly back that way.
        mock_article_content.style["transition-duration"] = `0s`;
        mock_article_content.style["background-color"] = `var(--article-bg)`;
        viewed_article.style.opacity = "0"

        let x = mock_article_content.offsetLeft;

        mock_article_content.style["transition-duration"] = `${trans}s`;
        mock_article_content.style["background-color"] = `var(--book-bg)`;

        article_content.classList.remove("open");
        mock_article_content.classList.remove("open");
        floating_loader.classList.remove("open");

        const book_rect = viewed_book.getBoundingClientRect();
            floating_loader.style.opacity = "1"
        floating_loader.style.left = `${book_rect.x}px`;
        floating_loader.style.top = `${book_rect.y}px`;
        floating_loader.style.height = `calc-size(${book_rect.height}px, size)`;
        floating_loader.style.width = `${book_rect.width}px`;

        viewer_view.style["background-color"] = "rgba(0, 0, 0, 0)";

        const navs = document.getElementsByClassName("viewer-nav");
        for (const nav of navs) {
          nav.classList.remove("open");
        }

        setTimeout(() => {
          viewed_book.style.opacity = 1;
          floating_loader.style.opacity = 0;
          setTimeout(() => {
            viewer_view.style.display = "none";
            // Reset
            floating_loader.style.opacity = 1;
            mock_article_content.style["background-color"] = ``;
          }, trans * 1000);
        }, trans * 1000);
      };

      /**
       * @param url (string)
       * @param load_callback (async (res, processed_content, text=null) => void)
       * NOTE: the text is already read on the res it'll be passed back as the text property, otherwise null
       */
      window.load_article = (url, load_callback) => {
        if (!url.includes("content")) {
          console.warn(
            `URL ${url} doesn't appear to be in the content folder, not loading`,
          );
          return;
        }
        const file_type = url.split(".").pop();

        // TODO: headers based on file type
        // TODO: update loaded article register (cache?)

        fetch(url, {
          headers: { "Content-Type": "text/plain" },
        }).then(async (res) => {
          let text = null;
          let processed = "";

          // Processing
          if (file_type === "md") {
            text = await res.text();
            // Run through MD parser
            processed = process_markdown(text);
          }

          await load_callback(res, processed, text);
        });
      };
    </script>
  </head>

  <body>
    <main
      class="screen"
      id="desk_view"
      ondrop="desk_view_drop(event)"
      ondragover="desk_view_dragover(event)"
    >
      <!-- THE DESK -->
      <section
        id="desktop"
        ondragover="desk_dragover(event)"
        ondrop="desktop_drop(event)"
      >
        <article
          draggable="true"
          ondragstart="article_ondragstart(event)"
          ondragend="article_ondragend(event)"
        >
          <h2>Test</h2>
          <p>This is the context of test two. Not the summary! Lololol.</p>
        </article>
      </section>

      <nav height="5em">
        <button onclick="go_to_shelf_view()">To Shelf</button>
      </nav>
    </main>

    <!-- THE SHELF -->

    <main class="screen" id="shelf_view">
      <nav id="shelftop">
        <section id="shelftop-content">
          <button onclick="go_to_desk_view()">To Desk</button>
        </section>
      </nav>

      <section id="shelf">
        <div class="shelf-seperator"></div>
        <section class="shelf-bay">
          <!-- Code populated start -->
          <article
            class="book"
            draggable="true"
            ondragstart="book_dragstart(event)"
            ondragend="book_dragend(event)"
            onpointerup="book_pointerup(event)"
            data-contenturl="content/dagloopyrpg/12 room dungeon blocks.md"
          >
            <h2>12 Room Dungeon Blocks</h2>
          </article>

          <article
            class="book"
            draggable="true"
            ondragstart="book_dragstart(event)"
            ondragend="book_dragend(event)"
            onpointerup="book_pointerup(event)"
            data-contenturl="content/dagloopyrpg/birthright, mausritter, rules light warfare.md"
          >
            <h2>Birthright, Mausritter, Rules Light Warfare</h2>
          </article>

          <!-- Code populated end -->
        </section>

        <div class="shelf-seperator"></div>
        <section class="shelf-bay"></section>
        <div class="shelf-seperator"></div>
        <section class="shelf-bay"></section>
        <div class="shelf-seperator"></div>
      </section>

      <section
        id="desk-drop-zone"
        ondragenter="enter_drop_zone(event)"
      ></section>
    </main>

    <template id="article-nav">
      <nav>
        <button onclick="close_viewer()">Back</button>
      </nav>
    </template>

    <main class="screen" id="viewer_view">

      <section id="floating_loader">
        <nav class="viewer-nav">
          <button onclick="close_viewer()">Back</button>
        </nav>
        <article id="mock_article_content"></article>
        <nav class="viewer-nav">
          <button onclick="close_viewer()">Back</button>
        </nav>
      </section>

      <section id="viewed_article">
        <nav>
          <button onclick="close_viewer()">Back</button>
        </nav>
        <article id="article_content"></article>
        <nav>
          <button onclick="close_viewer()">Back</button>
        </nav>
      </section>
    </main>
  </body>
</html>
